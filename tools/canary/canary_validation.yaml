job_queue: hp-elitebook-850-g7-notebook-pc
global_timeout: 3600
output_timeout: 1800
provision_data:
  distro: xenial
test_data:
  test_cmds: |
    #!/bin/bash

    # the machine running this script is the test controller
    # it runs on any device that consumes the jobs on given queue name, for instance "202111-29636"
    # the controller has a 1:1 relationship with the DUT (device under test)
    # to run anything on the DUT, the controller ssh's into the DUT and runs the commands there
    # and then in the end runs checkbox to run the actual testing session
    # the checkbox run is a typical remote session where the machine running this script is the
    # Checkbox Controller and the DUT is the Checkbox Agent

    set -x
    set -e

    # prepare Controller Machine
    sudo add-apt-repository -y ppa:checkbox-dev/edge
    sudo apt-get -qq update
    sudo DEBIAN_FRONTEND=noninteractive apt-get -qq install -y python-cheetah git checkbox-ng

    # get the tools necessary to prepare the target device for testing
    git -C hwcert-jenkins-tools pull -q || (rm -rf hwcert-jenkins-tools && git clone https://github.com/canonical/hwcert-jenkins-tools.git)

    export PATH=$PATH:hwcert-jenkins-tools/scriptlets

    # install checkbox runtime
    _run_retry sudo snap install checkbox16 --no-wait --channel=latest/edge
    wait_for_snap_complete
    # Let's list all the installed snaps for future debugging ease
    _run snap list

    _run_retry sudo snap install --devmode --channel=uc16/edge checkbox

    cat <<EOF > canary.launcher
    # Please keep the indents below, for yaml formatting/templating
    [launcher]
    launcher_version = 1
    stock_reports = certification

    [test plan]
    unit = com.canonical.certification::canary
    forced = yes

    [test selection]
    forced = true

    [ui]
    type = silent

    EOF

    # run the canary test plan
    PYTHONUNBUFFERED=1 checkbox-cli control $DEVICE_IP canary.launcher
    EXITCODE=$?
